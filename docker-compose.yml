services:
  filatique:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_VERSION: 22-alpine
    container_name: filatique
    restart: unless-stopped
    environment:
      NODE_ENV: production
      HOSTNAME: 0.0.0.0
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL}
    ports:
      - "3001:3000"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://localhost:3000/api/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1))\""
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - ph1l74-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=ph1l74-network"
      - "traefik.http.routers.filatique.rule=Host(`filatique.ru`) || Host(`www.filatique.ru`)"
      - "traefik.http.routers.filatique.entrypoints=web"
      - "traefik.http.routers.filatique.service=filatique"
      - "traefik.http.routers.filatique-secure.rule=Host(`filatique.ru`) || Host(`www.filatique.ru`)"
      - "traefik.http.routers.filatique-secure.entrypoints=websecure"
      - "traefik.http.routers.filatique-secure.service=filatique"
      - "traefik.http.routers.filatique-secure.tls=true"
      - "traefik.http.routers.filatique-secure.tls.certresolver=letsencrypt"
      - "traefik.http.middlewares.filatique-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.filatique-redirect.redirectscheme.permanent=true"
      - "traefik.http.routers.filatique.middlewares=filatique-redirect"
      - "traefik.http.services.filatique.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.filatique-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.filatique-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.filatique-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.filatique-headers.headers.stsPreload=true"
      - "traefik.http.routers.filatique-secure.middlewares=filatique-headers"
      - "traefik.http.middlewares.filatique-www-redirect.redirectregex.regex=^https://www\\.(.+)"
      - "traefik.http.middlewares.filatique-www-redirect.redirectregex.replacement=https://$$1"
      - "traefik.http.middlewares.filatique-www-redirect.redirectregex.permanent=true"

networks:
  ph1l74-network:
    external: true
